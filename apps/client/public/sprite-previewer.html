<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Abraxas ‚Äî NPC Body Sprite Previewer</title>
    <style>
      :root {
        --bg: #0d0d12;
        --card: #16161e;
        --border: #2a2a3a;
        --accent: #6e56cf;
        --text: #e0e0e6;
        --muted: #888;
        --highlight: #ffd700;
      }
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        font-family: "Inter", "Segoe UI", sans-serif;
        background: var(--bg);
        color: var(--text);
        padding: 24px;
      }
      h1 {
        font-size: 22px;
        margin-bottom: 6px;
        color: var(--highlight);
      }
      .subtitle {
        color: var(--muted);
        margin-bottom: 20px;
        font-size: 13px;
      }
      .controls {
        display: flex;
        gap: 12px;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }
      .controls label {
        font-size: 13px;
        color: var(--muted);
      }
      .controls input[type="range"] {
        width: 120px;
      }
      .controls input[type="text"] {
        background: var(--card);
        border: 1px solid var(--border);
        color: var(--text);
        padding: 6px 10px;
        border-radius: 6px;
        font-size: 13px;
        width: 200px;
      }
      .legend {
        display: flex;
        gap: 16px;
        margin-bottom: 16px;
        flex-wrap: wrap;
        font-size: 12px;
        color: var(--muted);
      }
      .legend .swatch {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 3px;
        margin-right: 4px;
        vertical-align: middle;
      }
      #grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 10px;
      }
      .card {
        background: var(--card);
        border: 2px solid var(--border);
        border-radius: 8px;
        padding: 10px;
        text-align: center;
        cursor: pointer;
        transition:
          border-color 0.15s,
          transform 0.1s;
        position: relative;
      }
      .card:hover {
        border-color: var(--accent);
        transform: scale(1.03);
      }
      .card.selected {
        border-color: var(--highlight);
        box-shadow: 0 0 12px rgba(255, 215, 0, 0.3);
      }
      .card.used-by-npc {
        border-color: #e05050;
      }
      .card.used-by-npc.selected {
        border-color: var(--highlight);
      }
      .card canvas {
        image-rendering: pixelated;
        display: block;
        margin: 0 auto 6px;
        background: #111118;
        border-radius: 4px;
      }
      .card .body-id {
        font-weight: 700;
        font-size: 14px;
      }
      .card .meta {
        font-size: 11px;
        color: var(--muted);
        margin-top: 2px;
      }
      .card .npc-tag {
        position: absolute;
        top: 4px;
        right: 4px;
        background: #e05050;
        color: #fff;
        font-size: 10px;
        font-weight: 600;
        padding: 1px 5px;
        border-radius: 4px;
      }
      .card .anim-badge {
        position: absolute;
        top: 4px;
        left: 4px;
        background: var(--accent);
        color: #fff;
        font-size: 10px;
        font-weight: 600;
        padding: 1px 5px;
        border-radius: 4px;
      }
      #status {
        color: var(--muted);
        font-size: 13px;
        margin-bottom: 12px;
      }
      #selection-panel {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: #1a1a26;
        border-top: 2px solid var(--accent);
        padding: 12px 24px;
        display: none;
        z-index: 100;
        font-size: 13px;
      }
      #selection-panel .row {
        display: flex;
        gap: 20px;
        align-items: center;
        flex-wrap: wrap;
      }
      #selection-panel .sel-body {
        font-weight: 700;
        color: var(--highlight);
        font-size: 16px;
      }
      #selection-panel button {
        background: var(--accent);
        color: #fff;
        border: none;
        padding: 6px 14px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 13px;
      }
      #selection-panel button:hover {
        opacity: 0.85;
      }
      #mapping-output {
        margin-top: 8px;
        font-family: "Fira Code", monospace;
        font-size: 12px;
        color: #aaffaa;
        white-space: pre-wrap;
        max-height: 120px;
        overflow-y: auto;
      }
      .npc-select {
        background: var(--card);
        border: 1px solid var(--border);
        color: var(--text);
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 13px;
      }
    </style>
  </head>
  <body>
    <h1>üßô NPC Body Sprite Previewer</h1>
    <p class="subtitle">
      Browse all body IDs from <code>cuerpos.json</code>. Click a card to assign
      it to an NPC type. Red border = currently used by an NPC.
    </p>

    <div class="controls">
      <label
        >Zoom: <input type="range" id="zoom" min="1" max="8" value="4" step="1"
      /></label>
      <label
        >Filter:
        <input
          type="text"
          id="filter"
          placeholder="Type to filter by body ID..."
      /></label>
      <label
        >Show:
        <select id="show-filter" class="npc-select">
          <option value="all">All bodies</option>
          <option value="animated">Animated only</option>
          <option value="static">Static only</option>
          <option value="used">Used by NPC</option>
          <option value="unused">Unused</option>
        </select>
      </label>
    </div>

    <div class="legend">
      <span
        ><span class="swatch" style="background: #e05050"></span> Currently used
        by NPC</span
      >
      <span
        ><span class="swatch" style="background: var(--accent)"></span>
        Animated</span
      >
      <span
        ><span class="swatch" style="background: var(--border)"></span> Static /
        not assigned</span
      >
    </div>

    <div id="status">Loading indices...</div>
    <div id="grid"></div>

    <div id="selection-panel">
      <div class="row">
        <span>Selected: <span class="sel-body" id="sel-body-id">‚Äî</span></span>
        <span
          >Assign to NPC:
          <select id="npc-assign" class="npc-select"></select>
        </span>
        <button id="btn-assign">Assign</button>
        <button id="btn-copy">Copy NPC_APPEARANCE</button>
      </div>
      <div id="mapping-output"></div>
    </div>

    <script>
      const NPC_APPEARANCE = {
        orc: { bodyId: 30, headId: 0 },
        skeleton: { bodyId: 35, headId: 0 },
        goblin: { bodyId: 45, headId: 0 },
        wolf: { bodyId: 65, headId: 0 },
        merchant: { bodyId: 5, headId: 0 },
        spider: { bodyId: 10, headId: 0 },
        ghost: { bodyId: 15, headId: 0 },
        lich: { bodyId: 70, headId: 0 },
        banker: { bodyId: 5, headId: 0 },
        zombie: { bodyId: 40, headId: 0 },
        troll: { bodyId: 25, headId: 0 },
        bat: { bodyId: 50, headId: 0 },
        dark_knight: { bodyId: 3, headId: 0 },
        horse: { bodyId: 65, headId: 0 },
        skeleton_archer: { bodyId: 35, headId: 0 },
        vampire: { bodyId: 70, headId: 0 },
        gargoyle: { bodyId: 50, headId: 0 },
        elephant: { bodyId: 80, headId: 0 },
        dragon: { bodyId: 85, headId: 0 },
        bear: { bodyId: 75, headId: 0 },
        mana_spring: { bodyId: 1, headId: 0 },
        explosive_trap: { bodyId: 3, headId: 0 },
        phantom_pet: { bodyId: 65, headId: 0 },
        decoy: { bodyId: 45, headId: 0 },
      };

      // Build reverse map: bodyId -> [npcNames]
      const bodyToNpc = {};
      for (const [name, app] of Object.entries(NPC_APPEARANCE)) {
        if (!bodyToNpc[app.bodyId]) bodyToNpc[app.bodyId] = [];
        bodyToNpc[app.bodyId].push(name);
      }

      // Editable mapping (user can reassign)
      const mapping = JSON.parse(JSON.stringify(NPC_APPEARANCE));

      let graficos, cuerpos;
      let selectedBodyId = null;
      const loadedImages = {};

      async function init() {
        const [gRes, cRes] = await Promise.all([
          fetch("/indices/graficos.json").then((r) => r.json()),
          fetch("/indices/cuerpos.json").then((r) => r.json()),
        ]);
        graficos = gRes;
        cuerpos = cRes;

        // Populate NPC select
        const select = document.getElementById("npc-assign");
        for (const name of Object.keys(NPC_APPEARANCE).sort()) {
          const opt = document.createElement("option");
          opt.value = name;
          opt.textContent = name;
          select.appendChild(opt);
        }

        renderGrid();
        setupControls();
      }

      function resolveStatic(grhId) {
        const entry = graficos[grhId];
        if (!entry) return null;
        if (typeof entry === "object" && "grafico" in entry) return entry;
        if (
          typeof entry === "object" &&
          "frames" in entry &&
          entry.frames.length > 0
        ) {
          return resolveStatic(entry.frames[0]);
        }
        return null;
      }

      function resolveAnim(grhId) {
        const entry = graficos[grhId];
        if (!entry || typeof entry !== "object" || !("frames" in entry))
          return null;
        const frames = [];
        for (const fid of entry.frames) {
          const s = resolveStatic(fid);
          if (s) frames.push(s);
        }
        return frames.length > 0
          ? { frames, velocidad: entry.velocidad }
          : null;
      }

      function loadImage(pngNum) {
        if (loadedImages[pngNum]) return loadedImages[pngNum];
        const p = new Promise((resolve) => {
          const img = new Image();
          img.onload = () => resolve(img);
          img.onerror = () => resolve(null);
          img.src = `/graficos/${pngNum}.webp`;
        });
        loadedImages[pngNum] = p;
        return p;
      }

      async function drawBodyOnCanvas(canvas, bodyId, zoom) {
        const entry = cuerpos[bodyId];
        if (!entry || typeof entry !== "object" || !("down" in entry))
          return false;

        const downGrhId = entry.down;
        const staticGrh = resolveStatic(downGrhId);
        if (!staticGrh) return false;

        const img = await loadImage(staticGrh.grafico);
        if (!img) return false;

        const w = staticGrh.width;
        const h = staticGrh.height;
        canvas.width = w * zoom;
        canvas.height = h * zoom;
        const ctx = canvas.getContext("2d");
        ctx.imageSmoothingEnabled = false;
        ctx.drawImage(
          img,
          staticGrh.offX,
          staticGrh.offY,
          w,
          h,
          0,
          0,
          w * zoom,
          h * zoom,
        );
        return true;
      }

      function getBodyInfo(bodyId) {
        const entry = cuerpos[bodyId];
        if (!entry || typeof entry !== "object" || !("down" in entry))
          return null;
        const downGrhId = entry.down;
        const isAnim =
          graficos[downGrhId] &&
          typeof graficos[downGrhId] === "object" &&
          "frames" in graficos[downGrhId];
        const staticGrh = resolveStatic(downGrhId);
        return {
          isAnim,
          frameCount: isAnim ? graficos[downGrhId].frames.length : 1,
          width: staticGrh ? staticGrh.width : "?",
          height: staticGrh ? staticGrh.height : "?",
          grafico: staticGrh ? staticGrh.grafico : "?",
        };
      }

      function renderGrid() {
        const grid = document.getElementById("grid");
        const zoom = parseInt(document.getElementById("zoom").value);
        const filterText = document.getElementById("filter").value.trim();
        const showFilter = document.getElementById("show-filter").value;
        grid.innerHTML = "";

        let count = 0;
        for (let i = 0; i < cuerpos.length; i++) {
          const entry = cuerpos[i];
          if (!entry || typeof entry !== "object" || !("down" in entry))
            continue;

          const info = getBodyInfo(i);
          if (!info) continue;

          // Filters
          if (filterText && !String(i).includes(filterText)) continue;
          const isUsed = !!bodyToNpc[i];
          if (showFilter === "animated" && !info.isAnim) continue;
          if (showFilter === "static" && info.isAnim) continue;
          if (showFilter === "used" && !isUsed) continue;
          if (showFilter === "unused" && isUsed) continue;

          const card = document.createElement("div");
          card.className =
            "card" +
            (isUsed ? " used-by-npc" : "") +
            (selectedBodyId === i ? " selected" : "");
          card.dataset.bodyId = i;

          if (isUsed) {
            const tag = document.createElement("div");
            tag.className = "npc-tag";
            tag.textContent = bodyToNpc[i].join(", ");
            card.appendChild(tag);
          }
          if (info.isAnim) {
            const badge = document.createElement("div");
            badge.className = "anim-badge";
            badge.textContent = `${info.frameCount}f`;
            card.appendChild(badge);
          }

          const canvas = document.createElement("canvas");
          canvas.width = 64;
          canvas.height = 64;
          card.appendChild(canvas);

          const idLabel = document.createElement("div");
          idLabel.className = "body-id";
          idLabel.textContent = `Body #${i}`;
          card.appendChild(idLabel);

          const meta = document.createElement("div");
          meta.className = "meta";
          meta.textContent = `${info.width}√ó${info.height} ‚Ä¢ grfico ${info.grafico}`;
          card.appendChild(meta);

          card.addEventListener("click", () => selectBody(i));

          grid.appendChild(card);
          drawBodyOnCanvas(canvas, i, zoom);
          count++;
        }

        document.getElementById("status").textContent =
          `Showing ${count} bodies`;
      }

      function selectBody(bodyId) {
        selectedBodyId = bodyId;
        document.querySelectorAll(".card").forEach((c) => {
          c.classList.toggle("selected", parseInt(c.dataset.bodyId) === bodyId);
        });
        document.getElementById("sel-body-id").textContent = `Body #${bodyId}`;
        document.getElementById("selection-panel").style.display = "block";
      }

      function setupControls() {
        document.getElementById("zoom").addEventListener("input", renderGrid);
        document.getElementById("filter").addEventListener("input", renderGrid);
        document
          .getElementById("show-filter")
          .addEventListener("change", renderGrid);

        document.getElementById("btn-assign").addEventListener("click", () => {
          if (selectedBodyId === null) return;
          const npc = document.getElementById("npc-assign").value;
          mapping[npc].bodyId = selectedBodyId;
          renderMappingOutput();
        });

        document.getElementById("btn-copy").addEventListener("click", () => {
          const code = generateCode();
          navigator.clipboard.writeText(code).then(() => {
            document.getElementById("btn-copy").textContent = "‚úì Copied!";
            setTimeout(
              () =>
                (document.getElementById("btn-copy").textContent =
                  "Copy NPC_APPEARANCE"),
              1500,
            );
          });
        });
      }

      function renderMappingOutput() {
        document.getElementById("mapping-output").textContent = generateCode();
      }

      function generateCode() {
        let code =
          "export const NPC_APPEARANCE: Record<string, { bodyId: number; headId: number }> = {\n";
        for (const [name, app] of Object.entries(mapping)) {
          const changed = app.bodyId !== NPC_APPEARANCE[name].bodyId;
          code += `  ${name}: { bodyId: ${app.bodyId}, headId: ${app.headId} },${changed ? " // ‚Üê CHANGED" : ""}\n`;
        }
        code += "};\n";
        return code;
      }

      init();
    </script>
  </body>
</html>
