generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

generator json {
  provider = "prisma-json-types-generator"
}

datasource db {
  provider = "postgresql"
}

enum AccountRole {
  USER
  GM
  ADMIN
}

enum CharacterClass {
  WARRIOR
  MAGE
  ROGUE
  CLERIC
  RANGER
  PALADIN
  NECROMANCER
  DRUID
}

enum GuildRole {
  LEADER
  OFFICER
  MEMBER
}

enum EquipSlot {
  HEAD
  CHEST
  LEGS
  FEET
  HANDS
  WEAPON_MAIN
  WEAPON_OFF
  RING1
  RING2
  AMULET
  MOUNT
}

enum QuestStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  TURNED_IN
}

model Account {
  id        String      @id @default(cuid())
  email     String      @unique
  password  String
  role      AccountRole @default(USER)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  characters Character[]

  friends  RequesterFriend[] @relation("Requester")
  friendOf RecipientFriend[] @relation("Recipient")
}

model RequesterFriend {
  id          String   @id @default(uuid())
  requesterId String
  requester   Account  @relation("Requester", fields: [requesterId], references: [id])
  recipientId String
  status      String   @default("PENDING")
  createdAt   DateTime @default(now())

  @@unique([requesterId, recipientId])
}

model RecipientFriend {
  id          String   @id @default(uuid())
  recipientId String
  recipient   Account  @relation("Recipient", fields: [recipientId], references: [id])
  requesterId String
  status      String   @default("PENDING")
  createdAt   DateTime @default(now())

  @@unique([recipientId, requesterId])
}

model Character {
  id        String  @id @default(cuid())
  accountId String
  account   Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  name        String         @unique
  class       CharacterClass
  level       Int            @default(1)
  exp         Int            @default(0)
  gold        Int            @default(0)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  lastLoginAt DateTime?

  mapId  String @default("")
  x      Float  @default(0)
  y      Float  @default(0)
  facing String @default("down")

  pvpEnabled  Boolean      @default(false)
  guildMember GuildMember?

  stats      CharacterStats?
  inventory  Inventory?
  bank       Bank?
  equipments Equipment[]

  companions Companion[]
  questLog   CharacterQuest[]

  @@index([accountId])
  @@index([mapId])
}

model Guild {
  id        String   @id @default(cuid())
  name      String   @unique
  createdAt DateTime @default(now())

  members GuildMember[]
}

model GuildMember {
  id      String @id @default(cuid())
  guildId String
  guild   Guild  @relation(fields: [guildId], references: [id], onDelete: Cascade)

  characterId String    @unique
  character   Character @relation(fields: [characterId], references: [id], onDelete: Cascade)

  role     GuildRole @default(MEMBER)
  joinedAt DateTime  @default(now())

  @@index([guildId])
}

model CharacterStats {
  id          String    @id @default(cuid())
  characterId String    @unique
  character   Character @relation(fields: [characterId], references: [id], onDelete: Cascade)

  str   Int @default(5)
  agi   Int @default(5)
  int   Int @default(5)
  maxHp Int @default(100)
  maxMp Int @default(50)
  hp    Int @default(100)
  mp    Int @default(50)
}

model ItemDef {
  id   String @id @default(cuid())
  code String @unique

  instances ItemInstance[]
}

model ItemInstance {
  id        String  @id @default(cuid())
  itemDefId String
  itemDef   ItemDef @relation(fields: [itemDefId], references: [id], onDelete: Restrict)

  boundToCharacterId String?

  inventorySlot InventorySlot?
  equipment     Equipment?
  bankSlot      BankSlot?
}

model Inventory {
  id          String    @id @default(cuid())
  characterId String    @unique
  character   Character @relation(fields: [characterId], references: [id], onDelete: Cascade)

  size  Int             @default(40)
  slots InventorySlot[]
}

model Bank {
  id          String    @id @default(cuid())
  characterId String    @unique
  character   Character @relation(fields: [characterId], references: [id], onDelete: Cascade)

  slots BankSlot[]
}

model BankSlot {
  id     String @id @default(cuid())
  bankId String
  bank   Bank   @relation(fields: [bankId], references: [id], onDelete: Cascade)

  idx    Int
  itemId String?       @unique
  item   ItemInstance? @relation(fields: [itemId], references: [id], onDelete: SetNull)

  qty Int @default(0)

  @@unique([bankId, idx])
  @@index([bankId])
  @@index([itemId])
}

model InventorySlot {
  id          String    @id @default(cuid())
  inventoryId String
  inventory   Inventory @relation(fields: [inventoryId], references: [id], onDelete: Cascade)

  idx    Int
  itemId String?       @unique
  item   ItemInstance? @relation(fields: [itemId], references: [id], onDelete: SetNull)

  qty Int @default(0)

  @@unique([inventoryId, idx])
  @@index([inventoryId])
  @@index([itemId])
}

model Equipment {
  id          String    @id @default(cuid())
  characterId String
  character   Character @relation(fields: [characterId], references: [id], onDelete: Cascade)

  slot   EquipSlot
  itemId String?       @unique
  item   ItemInstance? @relation(fields: [itemId], references: [id], onDelete: SetNull)

  @@unique([characterId, slot])
}

model Quest {
  id   String @id @default(cuid())
  code String @unique

  characterQuests CharacterQuest[]
}

model CharacterQuest {
  id          String    @id @default(cuid())
  characterId String
  character   Character @relation(fields: [characterId], references: [id], onDelete: Cascade)

  questId String
  quest   Quest  @relation(fields: [questId], references: [id], onDelete: Restrict)

  status       QuestStatus @default(NOT_STARTED)
  /// [QuestProgress]
  progressJson Json?
  startedAt    DateTime?
  completedAt  DateTime?

  @@unique([characterId, questId])
  @@index([characterId, status])
}

model Companion {
  id          String    @id @default(cuid())
  characterId String
  character   Character @relation(fields: [characterId], references: [id], onDelete: Cascade)

  type  String // e.g. "wolf", "skeleton", "horse"
  level Int    @default(1)
  exp   Int    @default(0)
  hp    Int    @default(1)

  @@index([characterId])
}
